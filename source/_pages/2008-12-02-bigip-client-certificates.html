--- 
layout: page
title: BigIP Client Certificates
tags: 
- bigip
- ldap
- ssl
status: publish
type: page
published: true
meta: 
  _edit_lock: "1268948435"
  _wp_page_template: default
  _edit_last: "1"
---
<style type="text/css">
table.addicted {
        border-width: 2px 2px 2px 2px;
        border-spacing: 0px;
        border-style: solid solid solid solid;
        border-color: gray gray gray gray;
        border-collapse: collapse;
        background-color: white;
        width: 80%;
}
table.addicted th {
        border-width: 1px 1px 1px 1px;
        padding: 1px 1px 1px 1px;
        border-style: outset outset outset outset;
        border-color: black black black black;
        background-color: #5c6d81;
        color: #000000;
        -moz-border-radius: 0px 0px 0px 0px;
}
table.addicted td {
        border-width: 1px 1px 1px 1px;
        padding: 1px 1px 1px 1px;
        border-style: outset outset outset outset;
        border-color: black black black black;
        background-color: white;
        color: #000000;
        -moz-border-radius: 0px 0px 0px 0px;
        overflow: hidden;
}
</style>

This howto will show you how to use client certificates to authenticate against applications hosted by a BigIP loadbalancer. You may find this howto (or parts of it) on <a href="http://ask.f5.com">ask.f5.com</a> as they was no documentation before on this topic. I forwarded it to F5 some time ago. <strong>This is the only way to use client certificates without purchasing addon modules from F5.</strong>

<h3>Purpose</h3>
<hr />
<p />

If you host a website/application which should only be accessible by some users you you may have already thought about client certificates. This makes brute force attacks against login panels impossible. 
This increases the overall application security by adding another layer a user must pass.

The mapping between certificates and access rights is based on a LDAP directory.

<h3>Overview</h3>
<hr />
<p />

The loadbalancer reads the CN from the client certificate and searches the defined group for the virtual server for a matching entry. The loadbalancer verifies CA and CRL's before the lookup takes place.

<center><a href="http://blog.linuxaddicted.de/wp-content/uploads/2008/12/f5_ldap_auth.png"><img src="http://blog.linuxaddicted.de/wp-content/uploads/2008/12/f5_ldap_auth.png" alt="BigIP Certificate Auth" title="f5_ldap_auth" width="388" height="339" class="size-full wp-image-141" /></a></center>

<h3>LDAP Setup</h3>
<hr />
<p />

<strong>Example Tree</strong>

<pre lang="perl">
                            dc=company,dc=com
                              /         \
                             /           \
                           ...      ou=datacenter
                                     /        \
                                    /          \
                                  ...       ou=webauth
                                              /    \
                                             /      \
                                       ou=users    ou=groups
</pre>

<strong>User & Group LDIF</strong>

Here are two LDIF examples for users and groups:

<center>User</center>
<code>dn: cn=Example User,ou=users,ou=webauth,ou=datacenter,dc=company,dc=com
cn: Example User
sn: Example User
objectClass: person
description: It's just a example user
</code>

<p />

<center>Group</center>
<code>dn: cn=Example Group,ou=groups,ou=webauth,ou=datacenter,dc=company,dc=com
cn: Example Group
objectClass: posixGroup
description: Group is allowed to connect to BigIP's VHOST secure.company.com
memberUid: cn=Example User,ou=users,ou=webauth,ou=datacenter,dc=company,dc=com
memberUid: cn=Example User No2,ou=users,ou=webauth,ou=datacenter,dc=company,dc=com
gidNumber: 145
</code>

The "memberUid" has to match exactly the certificates CN because this is the key the BigIP is looking for.

<h3>BigIP Configuration</h3>
<hr />
<p />

<strong>Authentication Configuration</strong>

As a firsz step we create a new "Authentication Configuration". Just open the web frontend and navigate to:

Local Traffic -> Profiles -> Authentication -> Configuration

You have to create a new config for every virtual host you want to secure. This is force by the LDAP group used because every config can only use one group. Here's a example configuration:

<table class="addicted">
  <tr>
    <th width="30%"><strong>Parameter</strong></th>
    <th width="70%"><strong>Value</strong></th>
  </tr>
  <tr>
    <td>Hosts</td>
    <td>1.2.3.4</td>
  </tr>
  <tr>
    <td>Search Type</td>
    <td>User</td>
  </tr>
  <tr>
    <td>User Base DN</td>
    <td>ou=users,ou=webauth,ou=datacenter,dc=company,dc=com</td>
  </tr>
  <tr>
    <td>User Key</td>
    <td>cn</td>
  </tr>
  </tr>
  <tr>
    <td>Admin DN</td>
    <td>DN for binding</td>
  </tr>
  <tr>
    <td>Admin Password</td>
    <td>Bind password</td>
  </tr>
  <tr>
    <td>Group Base DN</td>
    <td>ou=groups,ou=webauth,ou=datacenter,dc=company,dc=com</td>
  </tr>
  <tr>
    <td>Group Key</td>
    <td>cn</td>
  </tr>
  <tr>
    <td>Group Member Key</td>
    <td>memberUid</td>
  </tr>
  <tr>
    <td>Valid Groups</td>
    <td>Corresponding LDAP group</td>
  </tr>
</table>

<h3>Authentication Profile</h3>
<hr />
<p />

The next step is to create a profile which inherits the new created config. You need a profile for every configuration. Navigate to 

Local Traffic -> Profiles -> Authentication -> Profiles

<table class="addicted">
  <tr>
    <th width="30%"><strong>Parameter</strong></th>
    <th width="70%"><strong>Value</strong></th>
  </tr>
  <tr>
    <td>Type</td>
    <td>SSL Client Certificate LDAP</td>
  </tr>
  <tr>
    <td>Parent Profile</td>
    <td>ssl_cc_ldap</td>
  </tr>
  <tr>
    <td>Mode</td>
    <td>Enabled</td>
  </tr>
  <tr>
    <td>Configuration</td>
    <td>NAME OF CONF JUST CREATED</td>
  </tr>
</table>

<h3>CA Upload</h3>
<hr />
<p />

If your CA certificate(s) have not been installed it's time to do so. 

Local Traffic -> SSL Certificates -> Import

<h3>SSL Profiles</h3>
<hr />
<p />

To use SSL (without client certificates too) you need a SSL profile. Navigate to

Local Traffic -> Profiles -> SSL -> Client

Create a new profile based on "clientsl" or one of your already defined profiles.

<table class="addicted">
  <tr>
    <th width="30%"><strong>Parameter</strong></th>
    <th width="70%"><strong>Value</strong></th>
  </tr>
  <tr>
    <td>Chain</td>
    <td>CompanyBundle</td>
  </tr>
  <tr>
    <td>Trusted Certificate Authorities</td>
    <td>CompanyBundle</td>
  </tr>
  <tr>
    <td>Client Certificate</td>
    <td>require</td>
  </tr>
  <tr>
    <td>Frequency</td>
    <td>always</td>
  </tr>
  <tr>
    <td>Advertised Certificate Authorities</td>
    <td>CompanyBundle</td>
  </tr>
</table>

<h3>Virtual Host Configuration</h3>
<hr />
<p />

You may create a new virtual host or modify a existing host. Navigate here

Local Traffic -> Virtual Servers

Modify the following parameters (if you already used SSL in this vhost):

<table class="addicted">
  <tr>
    <th width="30%"><strong>Parameter</strong></th>
    <th width="70%"><strong>Value</strong></th>
  </tr>
  <tr>
    <td>SSL Profile (Client)</td>
    <td>Profile created earlier</td>
  </tr>
  <tr>
    <td>Authentication Profiles</td>
    <td>Profile created earlier</td>
  </tr>
</table>

<h3>That's it!</h3>
<hr />
<p />

Import your client certificates to your browser and enjoy your secure connection.

If you have any trouble don't hesitate to contact me: daniel {A_T} linuxaddicted {D_O_T} de
